name: tfcvault

on:
  push:
    branches: [ master ] 


jobs:
    build:
         runs-on: ubuntu-latest
         steps:
          
            - name: Import Secrets
              uses: hashicorp/vault-action@v2
              with:
                url: https://vault-cluster-public-vault-9bc72c0a.954833d8.z1.hashicorp.cloud:8200
                method: approle/role/my-role
                authPayload: |
                  {
                    "role_id": "${{ secrets.pki_int_config_issuers_role}}",
                    "secret_id": "${{ secrets.VAULT_AUTOMATION_SECRET_ID }}"
                  } 
                caCertificate: ${{ secrets.tfc_ca }}
                #method: token
                token: ${{ secrets.TFCVAULT }}
                namespace: admin/
                secrets: |
                   secret/sample-secret  accesskey | AWS_ACCESS_KEY_ID ;
                   secret/sample-secret secretkey | AWS_SECRET_ACCESS_KEY 
      
            - name: Unit Test
              run: |
                  mkdir -p ~/.aws
                  touch ~/.aws/credentials
                  echo "[default]
                  aws_access_key_id = ${{ env.AWS_ACCESS_KEY_ID }} 
                  aws_secret_access_key = ${{ env.AWS_SECRET_ACCESS_KEY }}
                  region = us-east-1"
                  aws --version 
