name: tf-kr-vault

on:
  push:
    branches: [ master ] 


jobs:
    build:
         runs-on: ubuntu-latest 
         steps:
            - name: VAULT COMMAND
              run: |
                  wget https://releases.hashicorp.com/consul/1.6.1/consul_1.6.1_linux_amd64.zip
                  unzip consul_1.6.1_linux_amd64.zip
                  sudo mv consul /usr/bin
                  consul
                  cat >> sudo nano /etc/system/system/consul.service
                  [Unit]
                  Description=Consul
                  Documentation=https://www.consul.io/
                  [Service]
                  ExecStart=/usr/bin/consul agent –server –ui –data-dir=/temp/consul –bootstrap-expect=1 –node=vault –bind=IP.ADDRESS.OF.SERVER –config-dir=/etc/consul.d/
                  ExecReload=/bin/kill –HUP $MAINPID
                  LimitNOFILE=65536
                  [Install]
                  WantedBy=multi-user.target
                  sudo mkdir /etc/consul.d
                  export VAULT_NAMESPACE=admin
                  cat >> nano /etc/consul.d/ui.json
                  {
                  “addresses”: {
                  “http”: “0.0.0.0”
                  }
                  }
                  systemctl daemon-reload
                  systemctl enable consul
                  journalctl –f –u consul
                  
                  vault namespace create -namespace=admin/education 
                  CAT >> edu-admin.hcl
                         path "sys/namespaces/*" {capabilities = ["create", "read", "update", "delete", "list", "sudo"]}
                         path "sys/policies/acl/*" {capabilities = ["create", "read", "update", "delete", "list", "sudo"]}
                         path "sys/policies/acl" {capabilities = ["list"]}
                         path "sys/mounts/*" {capabilities = ["create", "read", "update", "delete", "list"]}
                         path "sys/mounts" {capabilities = [ "read" ]}
                         path "identity/*" {capabilities = ["create", "read", "update", "delete", "list"]}
                         path "auth/token/*" {capabilities = ["create", "read", "update", "delete", "list", "sudo"]}
                         path "edu-secret/*" {capabilities = ["create", "read", "update", "delete", "list"]}
                         
                         
          
            - name: Import Secrets
              uses: hashicorp/vault-action@v2
              with:
                url: https://vault-cluster-public-vault-576b5917.b038600b.z1.hashicorp.cloud:8200/
                token: ${{ secrets.TFCVAULT }}
                caCertificate: ${{ secrets.VAULT_CA_CERT_HCP }}
                namespace: admin/education/
                exportToken: true
                secrets: |
                    /cubbyhole/my-secret my-token  | MY-TOKEN ;
                    /cubbyhole/my-secret my-value  | MY-VALUE  
            - name: Unit Test
              run: |
                  mkdir -p ~/.aws
                  touch ~/.aws/credentials
                  echo "[default]
                  username_id = ${{ env.MY-TOKEN }} 
                  password_id = ${{ env.MY-VALUE }}
                  region = us-east-1"
                  aws --version     
           
